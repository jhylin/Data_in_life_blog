{
  "hash": "ffc6f5fe1a578bc85da4377b6990a117",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Using R in Python - rpy2\"\nauthor: Jennifer HY Lin\ndate: 2025-11-9\ndraft: false\ncategories: \n    - Notes\n    - R\n    - Python\nformat: html\n---\n\nThis is something I've always wanted to try, that is using both R and Python in one place, so here it is.\n\nEssentially, I think there are two packages that may do the trick - one is rpy2 and the other is reticulate. I'll try rpy2 first in this post. For the notes about using reticulate package, it'll be in a [separate post](https://jhylin.github.io/Data_in_life_blog/posts/22_Back_to_basics/2_Using_python_in_r_reticulate.html).\n\nThere will be two different versions of code below where one is based on using R dataframe in Python and ggplot2, and the other one is based on pandas dataframe in Python with ggplot2. From my little experience using both versions of code, I'd say the second one using pandas and ggplot2 works better than the first (other more experienced users may have different opinions of course... there are always new things to learn for sure).\n\n<br>\n\n##### **Setting up notebook environment**\n\nSteps:\n\nThis notebook has been created using a virtual environment using uv, with the associated [repository](https://github.com/jhylin/Back_to_basics) created using the project structure from uv too. This step has been done prior to the executions of the following steps.\n\n1.  Install R with version at least 4.0 or above, and Python with version at least 3.7 or above (as suggested by this [post](https://rviews.rstudio.com/2022/05/25/calling-r-from-python-with-rpy2/)). The versions of Python and R used in this notebook are printed above the plot shown below.\n\n2.  Install R's language server as shown below.\n\n```{{r}}\ninstall.packages(\"languageserver\")\n```\n\n3.  Install [reticulate package](https://rstudio.github.io/reticulate/) ([GitHub repo](https://github.com/rstudio/reticulate/)). It's a useful R interface to Python and will be used in the other post.\n\n4.  Install rmarkdown package (may not be required as this is really just making sure that this note may be posted on my blog later that uses Quarto).\n\n5.  Install R extension for VS Code (may not be required as this is because I'm using VS Code. There is another very similar IDE called Positron created by Posit which may not require this step).\n\n6.  Install [rpy2 package](https://github.com/rpy2/rpy2). This notebook uses rpy2 version 3.6.4.\n\nNote: the installations of R-related packages need to be done in the R console in RStudio/Positron IDE or R terminal in VS Code. The R code above are not to be executed in Quarto markdown (.qmd) or RMarkdown (.rmd) documents as this will lead to an error message like this, \"trying to use CRAN without setting a mirror...\" when trying to preview the .qmd or .rmd.\n\n<br>\n\n##### **Using R dataframe in python and ggplot2**\n\n::: {#e9920198 .cell execution_count=1}\n``` {.python .cell-code}\nimport rpy2\n#import rpy2 as robjects\n## To print HTML in notebooks\n# import rpy2.ipython.html\n# rpy2.ipython.html.init_printing()\n\nfrom rpy2.robjects.packages import importr\n\n# Using a local converter\nfrom rpy2.robjects import conversion, default_converter\nwith conversion.localconverter(default_converter):\n\n    utils = importr('utils')\n    dataf = utils.read_csv(\"df_ml.csv\")\n    \n    #print(dataf)\n    print(dataf.colnames)\n\n    ## Visualising with ggplot2 in Python\n    import rpy2.robjects.lib.ggplot2 as gp\n\n    p = (gp.ggplot(dataf, gp.aes(x='Polar.Surface.Area', y='QED.Weighted')) + \n        # gp.aes(x='Polar.Surface.Area', y='QED.Weighted') + \n        gp.geom_point())\n\n    ## To see plots in an output cell - this doesn't work yet, it generates an empty .png with error message\n    from rpy2.ipython.ggplot import image_png\n    image_png(p)\n\n    ## this code seems to work by completing the run, but no plot is shown\n    # p.plot()\n\n    ## this code also seems to work but with no plot shown\n    # print(p)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nError importing in API mode: ImportError('dlopen(/Users/jenniferlin/Data_in_life_blog/.venv/lib/python3.12/site-packages/_rinterface_cffi_api.abi3.so, 0x0002): symbol not found in flat namespace (_R_BaseEnv)')\nTrying to import in ABI mode.\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Max_Phase\"          \"Polar.Surface.Area\" \"HBA\"               \n[4] \"HBD\"                \"X.RO5.Violations\"   \"QED.Weighted\"      \n[7] \"CX.LogP\"            \"CX.LogD\"            \"Heavy.Atoms\"       \n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nR callback write-console: In addition:   \nR callback write-console: Warning messages:\n  \nR callback write-console: 1:   \nR callback write-console: In grSoftVersion() :  \nR callback write-console: \n   \nR callback write-console:  unable to load shared object '/Library/Frameworks/R.framework/Resources/modules//R_X11.so':\n  dlopen(/Library/Frameworks/R.framework/Resources/modules//R_X11.so, 0x0006): Library not loaded: '/opt/X11/lib/libSM.6.dylib'\n  Referenced from: '/Library/Frameworks/R.framework/Versions/4.5-x86_64/Resources/modules/R_X11.so'\n  Reason: tried: '/opt/X11/lib/libSM.6.dylib' (no such file), '/usr/local/lib/libSM.6.dylib' (no such file), '/usr/lib/libSM.6.dylib' (no such file)\n  \nR callback write-console: 2:   \nR callback write-console: In cairoVersion() :  \nR callback write-console: \n   \nR callback write-console:  unable to load shared object '/Library/Frameworks/R.framework/Resources/library/grDevices/libs//cairo.so':\n  dlopen(/Library/Frameworks/R.framework/Resources/library/grDevices/libs//cairo.so, 0x0006): Library not loaded: '/opt/X11/lib/libSM.6.dylib'\n  Referenced from: '/Library/Frameworks/R.framework/Versions/4.5-x86_64/Resources/library/grDevices/libs/cairo.so'\n  Reason: tried: '/opt/X11/lib/libSM.6.dylib' (no such file), '/usr/local/lib/libSM.6.dylib' (no such file), '/usr/lib/libSM.6.dylib' (no such file)\n  \nR callback write-console: 3:   \nR callback write-console: In (function (filename = \"Rplot%03d.png\", width = 480, height = 480,  :  \nR callback write-console: \n   \nR callback write-console:  failed to load cairo DLL\n  \n```\n:::\n:::\n\n\n<br>\n\n##### **Coding issues**\n\nThe first coding issue encountered is that the code to produce a final output of the dataframe won't transform into a .qmd preview i.e. html page. There is an error message showing such as, \"Conversion rules for `rpy2.robjects` appear to be missing...\" when trying to preview this as a .qmd. One of the solutions I've found online ([code reference](https://stackoverflow.com/questions/75069677/rpy2-throws-a-notimplementederror-concerning-conversion-rules)) is to set up a local converter in the code and run all rpy2-related code within this converter (as commented in the code above).\n\nThe second issue is that I've only managed to run the code to show R dataframe in Python but not the plot... hence you will see the error message generated from the code above, with only the column names shown without a plot there. To resolve this issue, more time is spent on looking for answers online. A mini test has been done in a Jupyter notebook to show a short code to achieve a simple plot ([link to Jupyter notebook](https://github.com/jhylin/Back_to_basics/blob/main/1_Using_r_in_python_pd_ggplot2_rpy2.ipynb) which is based on this [code reference](https://stackoverflow.com/questions/43975244/displaying-r-ggplots-inline-in-jupyter-notebooks)) by calling R magic in Python kernel via rpy2. Once this works, I then manage to change the code to import a sample dataframe and set up to display a simple scatter plot as shown below.\n\n<br>\n\n##### **Using pandas and ggplot2**\n\n::: {#c3dd826a .cell execution_count=2}\n``` {.python .cell-code}\n# python version used\nimport sys\nprint(sys.version)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n3.12.7 (main, Oct 16 2024, 09:10:10) [Clang 18.1.8 ]\n```\n:::\n:::\n\n\n::: {#982d5eeb .cell execution_count=3}\n``` {.python .cell-code}\n# Load R magic\n%load_ext rpy2.ipython\n\nimport pandas as pd\n\ndf = pd.read_csv(\"df_ml.csv\")\ndf = df.rename(columns={\"QED Weighted\": \"QED\", \"Polar Surface Area\": \"PSA\"})\ndf.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Max_Phase</th>\n      <th>PSA</th>\n      <th>HBA</th>\n      <th>HBD</th>\n      <th>#RO5 Violations</th>\n      <th>QED</th>\n      <th>CX LogP</th>\n      <th>CX LogD</th>\n      <th>Heavy Atoms</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>66.81</td>\n      <td>4</td>\n      <td>1</td>\n      <td>0</td>\n      <td>0.47</td>\n      <td>3.94</td>\n      <td>3.94</td>\n      <td>32</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0</td>\n      <td>62.55</td>\n      <td>3</td>\n      <td>1</td>\n      <td>0</td>\n      <td>0.93</td>\n      <td>3.38</td>\n      <td>3.38</td>\n      <td>25</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>0</td>\n      <td>73.86</td>\n      <td>5</td>\n      <td>1</td>\n      <td>2</td>\n      <td>0.12</td>\n      <td>9.34</td>\n      <td>9.34</td>\n      <td>40</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>0</td>\n      <td>84.22</td>\n      <td>4</td>\n      <td>2</td>\n      <td>0</td>\n      <td>0.76</td>\n      <td>2.01</td>\n      <td>-0.19</td>\n      <td>26</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>0</td>\n      <td>40.46</td>\n      <td>4</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0.62</td>\n      <td>4.00</td>\n      <td>4.00</td>\n      <td>26</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n::: {#c5401f06 .cell execution_count=4}\n``` {.python .cell-code}\nfrom rpy2.robjects import conversion, default_converter\nwith conversion.localconverter(default_converter):\n\n    # R version\n    %R print(R.version.string)\n\n    # Importing ggplot2\n    %R require(ggplot2)\n\n    # Take name of input variable df and assign it to an R variable of the same name\n    %R -i df\n\n    # Plot the df\n    %R print(ggplot(df, aes(PSA, QED, colour = Max_Phase)) + geom_point())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"R version 4.5.1 (2025-06-13)\"\n```\n:::\n\n::: {.cell-output .cell-output-display}\n```\nIn addition: Warning message:\nIn (function (mapping = NULL, data = NULL, stat = \"identity\", position = \"identity\",  :\n  All aesthetics have length 1, but the data has 5670 rows.\nâ„¹ Please consider using `annotate()` or provide this layer with data containing\n  a single row.\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](1_Using_r_in_python_rpy2_files/figure-html/cell-5-output-3.png){}\n:::\n:::\n\n\n<br>\n\n##### **Dataframe libraries in R and Python**\n\nThere may be frequent debates about which programming language to use for data cleaning and manipulations. I'm open to use either whenever it suits really. As far as I'm aware, R has [dyplr](https://dplyr.tidyverse.org/) package (part of the core tidyverse packages) that is equivalent to pandas in Python (depending on personal preference and habits, different users will have different opinions about \"equivalence\" here). There is [Polars](https://docs.pola.rs/api/python/stable/reference/index.html) as well that's available to use in Python and R ([R Polars](https://pola-rs.github.io/r-polars/index.html)). I think there's also a more conventional base R code available that can be used to wrangle dataframes (e.g. a R package called [data.table](https://github.com/Rdatatable/data.table) that is based on base R's data.frame, it appears that it may be harder to learn than dyplr due to syntax but it'll be great for large datasets). There is a useful [post](https://atrebas.github.io/post/2019-03-03-datatable-dplyr/) suggested by R users online that introduces and explains data.table's differences from dyplr.\n\n",
    "supporting": [
      "1_Using_r_in_python_rpy2_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}